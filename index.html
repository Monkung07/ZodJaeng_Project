<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>Party Game Premium UI</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Round" rel="stylesheet">
    
    <style>
        /* --- Core Styles --- */
        html, body {
            background-color: #0f5132;
            background-image: radial-gradient(circle at center, #146c43 0%, #0a3622 100%);
            overflow: hidden; user-select: none; font-family: 'Sarabun', sans-serif;
            touch-action: none; height: 100vh; width: 100vw; position: fixed;
        }

        .scene {
            perspective: 1200px; width: 100%; height: 100vh;
            display: flex; align-items: center; justify-content: center; padding-top: 40px;
        }

        .deck-container { position: relative; width: 220px; height: 330px; }

        .card {
            position: absolute; width: 100%; height: 100%; border-radius: 1rem;
            transform-style: preserve-3d; cursor: pointer;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3); -webkit-tap-highlight-color: transparent;
        }

        .card-face {
            position: absolute; width: 100%; height: 100%; border-radius: 1rem;
            backface-visibility: hidden; display: flex; align-items: center; justify-content: center;
            text-align: center; padding: 20px; box-sizing: border-box; border: 1px solid rgba(0,0,0,0.1);
        }

        .card-back {
            background-color: #b91c1c;
            background-image: repeating-linear-gradient(45deg, #991b1b 25%, transparent 25%, transparent 75%, #991b1b 75%, #991b1b), repeating-linear-gradient(45deg, #991b1b 25%, #b91c1c 25%, #b91c1c 75%, #991b1b 75%, #991b1b);
            background-position: 0 0, 10px 10px; background-size: 20px 20px; border: 6px solid white;
        }
        .card-back::after { content: "‚ô†"; font-size: 4rem; color: white; opacity: 0.2; }

        .card-front {
            background: white; transform: rotateY(180deg); color: #1a1a1a;
            font-size: 1.5rem; font-weight: bold; border: 2px solid #e5e7eb;
        }

        .card.active {
            z-index: 3000 !important; transform: translate(0, -40px) scale(1.25) rotateY(180deg) !important;
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
            transition: transform 0.6s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .card.discarded {
            transform: translate(-150%, 0) rotate(-45deg) !important; opacity: 0; transition: all 0.4s ease-in;
        }

        @keyframes popIn { 0% { transform: scale(0.8); opacity: 0; } 50% { transform: scale(1.1); } 100% { transform: scale(1); opacity: 1; } }
        .text-pop { animation: popIn 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275) forwards; }

        .side-btn {
            background: rgba(255, 255, 255, 0.15); backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2); color: white;
            border-radius: 9999px; transition: all 0.2s;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            width: 70px; height: 70px; margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2); touch-action: manipulation;
        }
        .side-btn:hover { background: rgba(255, 255, 255, 0.3); transform: scale(1.1); }
        .side-btn:active { transform: scale(0.95); }
        .side-btn:disabled { opacity: 0.5; cursor: not-allowed; background: rgba(0,0,0,0.2); }
        .side-btn span { font-size: 24px; }
        .side-btn p { font-size: 10px; margin-top: 4px; font-weight: bold; }

        @media (min-width: 768px) {
            .deck-container { width: 300px; height: 450px; }
            .side-btn { width: 90px; height: 90px; }
            .side-btn span { font-size: 32px; }
            .side-btn p { font-size: 12px; }
        }

        /* --- New UI Components Styles --- */
        .glass-panel {
            background: rgba(15, 65, 40, 0.95); backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.15);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }
        
        input {
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2); color: white;
        }
        input:focus { outline: none; border-color: #facc15; box-shadow: 0 0 0 2px rgba(250, 204, 21, 0.3); }

        /* Custom Dropdown Styling */
        .custom-select-container { position: relative; width: 100%; }
        .custom-select-trigger {
            width: 100%; padding: 12px; border-radius: 0.75rem;
            background: rgba(0, 0, 0, 0.3); border: 1px solid rgba(255, 255, 255, 0.2);
            color: white; text-align: left; cursor: pointer;
            display: flex; justify-content: space-between; align-items: center;
        }
        .custom-select-trigger:focus { outline: none; border-color: #facc15; }
        .custom-options {
            position: absolute; top: 110%; left: 0; right: 0;
            background: #1a4d35; border: 1px solid rgba(255,255,255,0.1);
            border-radius: 0.75rem; overflow: hidden; z-index: 50;
            display: none; box-shadow: 0 10px 25px rgba(0,0,0,0.5);
        }
        .custom-options.open { display: block; animation: fadeIn 0.2s ease; }
        .custom-option {
            padding: 12px; cursor: pointer; transition: background 0.2s;
            display: flex; align-items: center; gap: 8px; color: white;
        }
        .custom-option:hover { background: rgba(255,255,255,0.1); }
        .custom-option.selected { background: rgba(250, 204, 21, 0.2); color: #facc15; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(-10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body>

    <div class="fixed top-6 w-full text-center z-40 pointer-events-none px-12">
        <h1 id="status-text" class="text-3xl md:text-5xl font-bold text-yellow-400 drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] text-pop leading-tight">
            ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÅ‡∏•‡πâ‡∏ß... ‡∏à‡∏±‡πà‡∏ß‡πÄ‡∏•‡∏¢!
        </h1>
        <p id="card-count" class="text-white/60 text-sm mt-2 font-bold"></p>
    </div>

    <div class="fixed right-4 top-1/2 transform -translate-y-1/2 z-50 flex flex-col items-center">
        <button onclick="toggleModal(true)" class="side-btn hover:bg-blue-500/40 border-blue-400/50">
            <span class="material-icons-round text-blue-300">edit</span>
            <p class="text-blue-100">‡πÅ‡∏Å‡πâ‡πÑ‡∏û‡πà</p>
        </button>
        <button id="btn-shuffle" onclick="startShuffleSequence()" class="side-btn bg-yellow-500/20 hover:bg-yellow-500/40 border-yellow-400/50">
            <span class="material-icons-round text-yellow-300">shuffle</span>
            <p class="text-yellow-100">‡∏™‡∏±‡∏ö‡πÑ‡∏û‡πà</p>
        </button>
        <button onclick="instantRestart()" class="side-btn hover:bg-white/20 border-white/20">
            <span class="material-icons-round">replay</span>
            <p>‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏´‡∏°‡πà</p>
        </button>
    </div>

    <div class="scene">
        <div class="deck-container" id="deck"></div>
    </div>

    <div id="custom-modal" class="fixed inset-0 z-[100] hidden bg-black/80 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-md p-6 rounded-2xl text-white">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-yellow-400 drop-shadow-sm flex items-center gap-2">
                    <span class="material-icons-round">edit_note</span> ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏≠‡∏á
                </h2>
                <button onclick="toggleModal(false)" class="text-green-200/70 hover:text-white transition">
                    <span class="material-icons-round">close</span>
                </button>
            </div>

            <div class="space-y-5">
                <div>
                    <label class="text-xs text-green-200/70 uppercase tracking-wider font-bold">‡∏Ñ‡∏≥‡∏™‡∏±‡πà‡∏á‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πå‡∏î</label>
                    <input type="text" id="inp-text" placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡∏Ñ‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏î‡∏∑‡πà‡∏° 2 ‡πÅ‡∏Å‡πâ‡∏ß..." class="w-full p-3 rounded-xl mt-2">
                </div>

                <div class="flex gap-4">
                    <div class="w-2/3">
                        <label class="text-xs text-green-200/70 uppercase tracking-wider font-bold">‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó</label>
                        
                        <div class="custom-select-container mt-2">
                            <div class="custom-select-trigger" onclick="toggleCustomSelect()">
                                <span id="selected-val-display" class="flex items-center gap-2">üç∫ ‡∏î‡∏∑‡πà‡∏° (Drink)</span>
                                <span class="material-icons-round text-sm">expand_more</span>
                            </div>
                            <div class="custom-options" id="custom-options-list">
                                <div class="custom-option selected" onclick="selectOption('drink', 'üç∫ ‡∏î‡∏∑‡πà‡∏° (Drink)')">üç∫ ‡∏î‡∏∑‡πà‡∏° (Drink)</div>
                                <div class="custom-option" onclick="selectOption('hard', 'üî• ‡πÇ‡∏´‡∏î (Hard)')">üî• ‡πÇ‡∏´‡∏î (Hard)</div>
                                <div class="custom-option" onclick="selectOption('action', 'üíÉ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Action)')">üíÉ ‡∏Å‡∏¥‡∏à‡∏Å‡∏£‡∏£‡∏° (Action)</div>
                                <div class="custom-option" onclick="selectOption('lucky', 'üçÄ ‡∏£‡∏≠‡∏î‡∏ï‡∏±‡∏ß (Lucky)')">üçÄ ‡∏£‡∏≠‡∏î‡∏ï‡∏±‡∏ß (Lucky)</div>
                            </div>
                            <input type="hidden" id="inp-type" value="drink">
                        </div>
                        </div>
                    <div class="w-1/3">
                        <label class="text-xs text-green-200/70 uppercase tracking-wider font-bold">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÉ‡∏ö</label>
                        <input type="number" id="inp-count" value="1" min="1" max="50" class="w-full p-3 rounded-xl mt-2 text-center">
                    </div>
                </div>

                <button onclick="addCustomCard()" class="w-full bg-yellow-500 hover:bg-yellow-400 text-black font-bold py-3 rounded-xl transition transform active:scale-95 shadow-lg shadow-yellow-500/20">
                    + ‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏Ç‡πâ‡∏≤‡∏Å‡∏≠‡∏á
                </button>
            </div>

            <hr class="border-white/10 my-6">

            <div class="flex flex-col gap-3">
                <div class="flex justify-between text-sm text-green-200/80 px-1">
                    <span>‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÉ‡∏ô‡∏Å‡∏≠‡∏á‡∏ï‡∏≠‡∏ô‡∏ô‡∏µ‡πâ: <strong id="modal-total" class="text-yellow-400 text-base">14</strong> ‡πÉ‡∏ö</span>
                </div>
                
                <div class="flex gap-3">
                    <button onclick="openConfirm('restore')" class="flex-1 py-3 border border-white/20 text-gray-300 rounded-xl hover:bg-white/10 text-sm font-bold transition">
                        ‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô
                    </button>
                    <button onclick="openConfirm('clear')" class="flex-1 py-3 border border-red-500/40 text-red-300 rounded-xl hover:bg-red-500/20 text-sm font-bold transition">
                        ‡∏•‡πâ‡∏≤‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
                    </button>
                </div>
                <button onclick="applyAndClose()" class="w-full py-3 bg-green-500 hover:bg-green-400 text-white rounded-xl shadow-lg shadow-green-500/30 font-bold transition transform active:scale-95">
                    ‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡πÅ‡∏•‡∏∞‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÄ‡∏•‡πà‡∏ô
                </button>
            </div>
        </div>
    </div>

    <div id="confirm-modal" class="fixed inset-0 z-[110] hidden bg-black/80 flex items-center justify-center p-4">
        <div class="glass-panel w-full max-w-sm p-6 rounded-2xl text-center">
            <div class="w-16 h-16 bg-red-500/20 rounded-full flex items-center justify-center mx-auto mb-4">
                <span class="material-icons-round text-3xl text-red-400">warning</span>
            </div>
            <h3 id="confirm-title" class="text-xl font-bold text-white mb-2">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô‡∏Å‡∏≤‡∏£‡∏•‡∏ö?</h3>
            <p id="confirm-desc" class="text-white/60 text-sm mb-6">‡∏Å‡∏≤‡∏£‡∏Å‡∏£‡∏∞‡∏ó‡∏≥‡∏ô‡∏µ‡πâ‡πÑ‡∏°‡πà‡∏™‡∏≤‡∏°‡∏≤‡∏£‡∏ñ‡∏¢‡πâ‡∏≠‡∏ô‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏î‡πâ</p>
            <div class="flex gap-3">
                <button onclick="closeConfirm()" class="flex-1 py-2 rounded-lg border border-white/20 text-white hover:bg-white/10">‡∏¢‡∏Å‡πÄ‡∏•‡∏¥‡∏Å</button>
                <button id="confirm-yes-btn" class="flex-1 py-2 rounded-lg bg-red-500 hover:bg-red-600 text-white font-bold">‡∏¢‡∏∑‡∏ô‡∏¢‡∏±‡∏ô</button>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('gesturestart', function(e) { e.preventDefault(); });
        document.addEventListener('dblclick', function(e) { e.preventDefault(); }, { passive: false });

        const SoundFX = {
            ctx: null, buffer: null,
            init: function() {
                if (!this.ctx) { this.ctx = new (window.AudioContext || window.webkitAudioContext)(); }
                if (this.ctx.state === 'suspended') this.ctx.resume();
                if (!this.buffer) {
                    const duration = 0.1; const sampleRate = this.ctx.sampleRate;
                    const bufferSize = sampleRate * duration;
                    const buffer = this.ctx.createBuffer(1, bufferSize, sampleRate);
                    const data = buffer.getChannelData(0);
                    for (let i = 0; i < bufferSize; i++) { data[i] = (Math.random() * 2 - 1) * 0.1; }
                    this.buffer = buffer;
                }
            },
            playSnap: function() { this.playNoise(800, 'highpass'); },
            playSlide: function() { this.playOsc(150, 'triangle', 0.2); },
            playTone: function(freq, type) { this.playOsc(freq, type, 0.3); },
            playNoise: function(freq, type) {
                if (!this.ctx || !this.buffer) return;
                const src = this.ctx.createBufferSource(); src.buffer = this.buffer;
                const f = this.ctx.createBiquadFilter(); f.type = type; f.frequency.value = freq;
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0, this.ctx.currentTime);
                g.gain.linearRampToValueAtTime(0.8, this.ctx.currentTime + 0.005);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + 0.04);
                src.connect(f); f.connect(g); g.connect(this.ctx.destination);
                src.start(); src.stop(this.ctx.currentTime + 0.1);
            },
            playOsc: function(freq, type, dur) {
                if (!this.ctx) return;
                const osc = this.ctx.createOscillator(); osc.type = type; osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
                const g = this.ctx.createGain(); g.gain.setValueAtTime(0.1, this.ctx.currentTime);
                g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + dur);
                osc.connect(g); g.connect(this.ctx.destination);
                osc.start(); osc.stop(this.ctx.currentTime + dur);
            }
        };

        const defaultDeckData = [
            { text: "‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡∏ß‡πÄ‡∏î‡∏µ‡πã‡∏¢‡∏ß‡∏ô‡∏µ‡πâ!", type: "hard" },
            { text: "‡∏Ñ‡∏ô‡∏ã‡πâ‡∏≤‡∏¢‡∏î‡∏∑‡πà‡∏° 1", type: "drink" },
            { text: "‡∏Ñ‡∏ô‡∏Ç‡∏ß‡∏≤‡∏î‡∏∑‡πà‡∏° 1", type: "drink" },
            { text: "‡∏à‡πâ‡∏≠‡∏á‡∏ï‡∏≤‡∏´‡πâ‡∏≤‡∏°‡∏Å‡∏£‡∏∞‡∏û‡∏£‡∏¥‡∏ö", type: "action" },
            { text: "‡∏Ñ‡∏ô‡πÉ‡∏™‡πà‡πÅ‡∏ß‡πà‡∏ô‡∏î‡∏∑‡πà‡∏°", type: "drink" },
            { text: "‡πÉ‡∏Ñ‡∏£‡πÇ‡∏™‡∏î‡∏î‡∏∑‡πà‡∏°‡∏´‡∏°‡∏î‡πÅ‡∏Å‡πâ‡∏ß", type: "hard" },
            { text: "‡πÄ‡∏•‡πà‡∏≤‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏ú‡∏µ", type: "action" },
            { text: "‡πÄ‡∏ï‡πâ‡∏ô‡πÑ‡∏Å‡πà‡∏¢‡πà‡∏≤‡∏á 10 ‡∏ß‡∏¥", type: "action" },
            { text: "‡πÇ‡∏ó‡∏£‡∏´‡∏≤‡πÅ‡∏ü‡∏ô‡πÄ‡∏Å‡πà‡∏≤", type: "hard" },
            { text: "‡∏û‡∏π‡∏î‡∏Ñ‡∏ß‡∏≤‡∏°‡∏•‡∏±‡∏ö", type: "action" },
            { text: "‡πÄ‡∏õ‡πà‡∏≤‡∏¢‡∏¥‡πâ‡∏á‡∏â‡∏∏‡∏ö‡∏Ñ‡∏ô‡∏Ç‡πâ‡∏≤‡∏á‡πÜ", type: "drink" },
            { text: "‡∏Ñ‡∏ô‡πÄ‡∏™‡∏∑‡πâ‡∏≠‡∏î‡∏≥‡∏î‡∏∑‡πà‡∏°", type: "drink" },
            { text: "Free Turn!", type: "lucky" },
            { text: "‡∏û‡∏±‡∏Å‡∏î‡∏∑‡πà‡∏°‡∏ô‡πâ‡∏≥ 1 ‡πÅ‡∏Å‡πâ‡∏ß", type: "lucky" }
        ];

        let masterDeck = []; 
        let activeDeck = [];
        let currentDeckState = [];

        const reactionMap = {
            hard: ["‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö‡∏à‡∏≤‡∏£‡∏¢‡πå!", "‡∏™‡∏π‡πà‡∏Ç‡∏¥‡∏ï...", "‡∏•‡∏≤‡∏Å‡πà‡∏≠‡∏¢‡∏¢‡∏¢‡∏¢‡∏¢", "‡πÑ‡∏°‡πà‡πÑ‡∏´‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏ù‡∏∑‡∏ô"],
            drink: ["‡∏Ñ‡∏≠‡πÅ‡∏´‡πâ‡∏á‡∏û‡∏≠‡∏î‡∏µ‡πÄ‡∏•‡∏¢", "‡∏´‡∏ß‡∏≤‡∏ô‡πÄ‡∏à‡∏µ‡πä‡∏¢‡∏ö‡∏ö‡∏ö", "‡∏ä‡∏ô‡πÅ‡∏Å‡πâ‡∏ß‡∏Ñ‡∏£‡∏±‡∏ö‡∏ú‡∏°", "‡πÄ‡∏ö‡∏≤‡πÜ ‡∏Å‡∏£‡∏∏‡∏ö‡∏Å‡∏£‡∏¥‡∏ö"],
            action: ["‡∏≠‡∏¢‡πà‡∏≤‡πÄ‡∏Ç‡∏¥‡∏ô‡∏î‡∏¥‡∏ß‡∏∞!", "‡πÄ‡∏≠‡∏≤‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î!", "‡∏Å‡∏•‡πâ‡∏≤‡∏õ‡πà‡∏≤‡∏ß‡∏ß‡∏ß?", "‡∏Ç‡∏≠‡∏ï‡∏∂‡∏á‡πÜ ‡∏ô‡∏∞"],
            lucky: ["‡∏ó‡∏≥‡∏ö‡∏∏‡∏ç‡∏î‡πâ‡∏ß‡∏¢‡∏≠‡∏∞‡πÑ‡∏£‡∏°‡∏≤?", "‡∏£‡∏≠‡∏î‡πÄ‡∏â‡∏¢‡∏¢‡∏¢‡∏¢", "‡πÅ‡∏ï‡πâ‡∏°‡∏ö‡∏∏‡∏ç‡∏™‡∏π‡∏á‡∏ô‡∏∞‡πÄ‡∏£‡∏≤", "‡∏á‡∏ß‡∏î‡∏ô‡∏µ‡πâ‡∏´‡∏ß‡∏¢‡∏≠‡∏≠‡∏Å‡πÅ‡∏ô‡πà"]
        };
        const waitingTexts = ["‡∏ï‡∏≤‡πÉ‡∏Ñ‡∏£‡πÄ‡∏≠‡πà‡∏¢?", "‡∏°‡∏∑‡∏≠‡∏™‡∏±‡πà‡∏ô‡∏ó‡∏≥‡πÑ‡∏°?", "‡πÉ‡∏ö‡∏ï‡πà‡∏≠‡πÑ‡∏õ‡πÇ‡∏´‡∏î‡πÅ‡∏ô‡πà", "‡∏´‡∏¢‡∏¥‡∏ö‡∏™‡∏¥ ‡∏≠‡∏¢‡πà‡∏≤‡∏•‡∏µ‡∏•‡∏≤"];

        const deckContainer = document.getElementById('deck');
        const statusText = document.getElementById('status-text');
        const countText = document.getElementById('card-count');
        const shuffleBtn = document.getElementById('btn-shuffle');
        const modal = document.getElementById('custom-modal');
        const confirmModal = document.getElementById('confirm-modal');
        let isShuffling = false;

        // --- Custom Dropdown Logic ---
        function toggleCustomSelect() {
            document.getElementById('custom-options-list').classList.toggle('open');
        }
        function selectOption(value, text) {
            document.getElementById('inp-type').value = value;
            document.getElementById('selected-val-display').innerText = text;
            
            // Update active state
            document.querySelectorAll('.custom-option').forEach(el => el.classList.remove('selected'));
            event.target.classList.add('selected');
            
            toggleCustomSelect();
        }
        // ‡∏õ‡∏¥‡∏î Dropdown ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡∏ó‡∏µ‡πà‡∏≠‡∏∑‡πà‡∏ô
        window.onclick = function(event) {
            if (!event.target.matches('.custom-select-trigger') && !event.target.matches('.custom-select-trigger *')) {
                document.getElementById('custom-options-list').classList.remove('open');
            }
        }

        // --- Confirm Modal Logic ---
        function openConfirm(action) {
            confirmModal.classList.remove('hidden');
            const btnYes = document.getElementById('confirm-yes-btn');
            
            if (action === 'clear') {
                document.getElementById('confirm-title').innerText = "‡∏•‡πâ‡∏≤‡∏á‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î?";
                document.getElementById('confirm-desc').innerText = "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏ó‡∏µ‡πà‡∏Ñ‡∏∏‡∏ì‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏≠‡∏á‡∏à‡∏∞‡∏´‡∏≤‡∏¢‡πÑ‡∏õ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î";
                btnYes.onclick = () => { doClearDeck(); closeConfirm(); };
            } else if (action === 'restore') {
                document.getElementById('confirm-title').innerText = "‡∏Ñ‡∏∑‡∏ô‡∏Ñ‡πà‡∏≤‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô?";
                document.getElementById('confirm-desc').innerText = "‡∏Å‡∏≤‡∏£‡πå‡∏î‡∏õ‡∏±‡∏à‡∏à‡∏∏‡∏ö‡∏±‡∏ô‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡πÅ‡∏ó‡∏ô‡∏ó‡∏µ‡πà‡∏î‡πâ‡∏ß‡∏¢‡∏ä‡∏∏‡∏î‡∏°‡∏≤‡∏ï‡∏£‡∏ê‡∏≤‡∏ô";
                btnYes.onclick = () => { doRestoreDeck(); closeConfirm(); };
            }
        }
        function closeConfirm() {
            confirmModal.classList.add('hidden');
        }

        function loadDeck() {
            const saved = localStorage.getItem('party_game_deck');
            if (saved) {
                try { masterDeck = JSON.parse(saved); } catch(e) { masterDeck = [...defaultDeckData]; }
            } else {
                masterDeck = [...defaultDeckData];
            }
        }
        function saveDeck() { localStorage.setItem('party_game_deck', JSON.stringify(masterDeck)); }

        function toggleModal(show) {
            if (show) {
                modal.classList.remove('hidden');
                document.getElementById('modal-total').innerText = masterDeck.length;
            } else {
                modal.classList.add('hidden');
            }
        }

        function addCustomCard() {
            const text = document.getElementById('inp-text').value.trim();
            const type = document.getElementById('inp-type').value;
            const count = parseInt(document.getElementById('inp-count').value);
            if (!text) return alert("‡πÉ‡∏™‡πà‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏¥‡∏Ñ‡∏£‡∏±‡∏ö!");
            for(let i=0; i<count; i++) { masterDeck.push({ text, type }); }
            saveDeck();
            document.getElementById('inp-text').value = '';
            document.getElementById('modal-total').innerText = masterDeck.length;
            const btn = document.querySelector('button[onclick="addCustomCard()"]');
            const originalText = btn.innerHTML;
            btn.innerHTML = "<span class='material-icons-round'>check</span> ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢!";
            setTimeout(() => btn.innerHTML = originalText, 1000);
        }

        function doClearDeck() {
            masterDeck = [];
            saveDeck();
            document.getElementById('modal-total').innerText = 0;
        }
        
        function doRestoreDeck() {
            masterDeck = [...defaultDeckData];
            saveDeck();
            document.getElementById('modal-total').innerText = masterDeck.length;
        }

        function applyAndClose() {
            if (masterDeck.length === 0) return alert("‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Å‡∏≤‡∏£‡πå‡∏î‡πÄ‡∏•‡∏¢! ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Å‡πà‡∏≠‡∏ô‡∏™‡∏¥");
            instantRestart();
            toggleModal(false);
        }

        function updateStatus(mode, category = null) {
            let text = "";
            statusText.className = "text-3xl md:text-5xl font-bold drop-shadow-[0_2px_4px_rgba(0,0,0,0.8)] leading-tight"; 
            void statusText.offsetWidth;
            statusText.classList.add('text-pop');
            if (mode === 'waiting') {
                if (currentDeckState.length === 0) {
                    text = "‡∏´‡∏°‡∏î‡∏Å‡∏≠‡∏á‡πÅ‡∏•‡πâ‡∏ß!"; statusText.classList.add('text-gray-300'); shuffleBtn.disabled = true;
                } else {
                    text = waitingTexts[Math.floor(Math.random() * waitingTexts.length)];
                    statusText.classList.add('text-yellow-400'); shuffleBtn.disabled = false;
                }
            } else if (mode === 'reaction' && category) {
                const options = reactionMap[category] || reactionMap['drink'];
                text = options[Math.floor(Math.random() * options.length)];
                if (category === 'hard') statusText.classList.add('text-red-600'); 
                else if (category === 'lucky') statusText.classList.add('text-green-400'); 
                else statusText.classList.add('text-red-400'); 
            }
            statusText.innerText = text;
            countText.innerText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentDeckState.length} ‡πÉ‡∏ö`;
        }

        function instantRestart() {
            if (isShuffling) return;
            SoundFX.init(); SoundFX.playSlide();
            activeDeck = masterDeck.map((c, i) => ({ ...c, id: i }));
            currentDeckState = [...activeDeck];
            deployRealDeck();
            updateStatus('waiting');
        }

        function startShuffleSequence() {
            if (isShuffling || currentDeckState.length === 0) return;
            isShuffling = true;
            SoundFX.init();
            deckContainer.innerHTML = ''; 
            updateStatus('waiting'); 
            const STUNT_COUNT = Math.min(8, currentDeckState.length);
            const stuntCards = [];
            for(let i=0; i<STUNT_COUNT; i++) {
                const c = document.createElement('div'); c.className = 'card';
                c.innerHTML = `<div class="card-face card-back"></div>`;
                deckContainer.appendChild(c); stuntCards.push(c);
            }
            stuntCards.forEach((c, i) => {
                setTimeout(() => {
                    SoundFX.playSnap();
                    c.style.transition = 'transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1)';
                    const spread = (i - STUNT_COUNT/2) * 25;
                    c.style.transform = `translate(${spread}px, -110px) rotate(${(i - STUNT_COUNT/2)*5}deg)`;
                }, i * 30);
            });
            const fallTime = (STUNT_COUNT * 30) + 500;
            stuntCards.forEach((c, i) => {
                setTimeout(() => {
                    c.style.transition = 'transform 0.6s cubic-bezier(0.175, 0.885, 0.32, 1.275)';
                    c.style.transform = `translate(0,0) rotate(${Math.random()*2-1}deg)`;
                }, fallTime + (i * 50));
            });
            setTimeout(() => { deployRealDeck(); isShuffling = false; }, fallTime + (STUNT_COUNT * 50) + 800);
        }

        function deployRealDeck() {
            deckContainer.innerHTML = '';
            const shuffled = [...currentDeckState].sort(() => Math.random() - 0.5);
            shuffled.forEach((item, index) => {
                const card = document.createElement('div');
                card.className = 'card';
                card.style.zIndex = index + 1;
                card.dataset.id = item.id;
                card.dataset.type = item.type;
                card.style.transform = `translate(0,0) rotate(${Math.random()*2-1}deg)`;
                card.innerHTML = `
                    <div class="card-face card-back"></div>
                    <div class="card-face card-front">
                        <div class="flex flex-col items-center px-4">
                            <span class="text-3xl mb-4">üçª</span>
                            <span>${item.text}</span>
                        </div>
                    </div>
                `;
                card.onclick = () => handleCardClick(card);
                deckContainer.appendChild(card);
            });
            countText.innerText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentDeckState.length} ‡πÉ‡∏ö`;
        }

        function handleCardClick(card) {
            if (isShuffling || card.classList.contains('discarded')) return;
            SoundFX.init();
            if (card.classList.contains('active')) {
                SoundFX.playSlide();
                card.classList.remove('active');
                card.classList.add('discarded');
                const id = parseInt(card.dataset.id);
                currentDeckState = currentDeckState.filter(c => c.id !== id);
                countText.innerText = `‡πÄ‡∏´‡∏•‡∏∑‡∏≠ ${currentDeckState.length} ‡πÉ‡∏ö`;
                setTimeout(() => updateStatus('waiting'), 300);
                setTimeout(() => card.remove(), 600);
            } else {
                const next = card.nextElementSibling;
                if (!next || next.classList.contains('discarded')) {
                    card.classList.add('active');
                    updateStatus('reaction', card.dataset.type);
                    const t = card.dataset.type;
                    if(t==='hard') SoundFX.playTone(100, 'sawtooth');
                    else if(t==='lucky') SoundFX.playTone(600, 'sine');
                    else SoundFX.playTone(400, 'sine');
                }
            }
        }

        // Init
        loadDeck();
        setTimeout(() => instantRestart(), 100);
    </script>
</body>
</html>